<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5">
  <Import Project="$(MetaBuildBinDir)\MetaBuild.Module.targets" />

  <ItemGroup>
    <CSharpProject Include="Gallio\Gallio$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio35\Gallio35$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio.ControlPanel\Gallio.ControlPanel$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio.Host\Gallio.Host$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio.Tests\Gallio.Tests$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio.Loader\Gallio.Loader$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio.Reports\Gallio.Reports$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio.UI\Gallio.UI$(ProjectVariant).csproj" />
    
    <CSharpProject Include="Gallio.Utility\Gallio.Utility$(ProjectVariant).csproj" />
    
    <DocumentedAssembly Include="Gallio\bin\Gallio.dll" />
    <DocumentedAssembly Include="Gallio35\bin\Gallio35.dll" />
    <DocumentedAssembly Include="Gallio.Loader\bin\Gallio.Loader.dll" />
    <DocumentedAssembly Include="Gallio.Reports\bin\Gallio.Reports.dll" />
    <DocumentedAssembly Include="Gallio.UI\bin\Gallio.UI.dll" />
    
    <Content Include="Gallio Website.url" />
  
    <Binary Include="Gallio\bin\Gallio.XmlSerializers.dll" />
    <PluginFile Include="Gallio\Gallio.plugin" />
    <Binary Include="Gallio\Resources\*.ico">
      <Folder>Resources</Folder>
    </Binary>

    <Binary Include="Gallio\bin\Gallio.Host.exe" />
    <PluginFile Include="Gallio\bin\Gallio.Host.exe.config" />
    <Binary Include="Gallio\bin\Gallio.Host.x86.exe" />
    <PluginFile Include="Gallio\bin\Gallio.Host.x86.exe.config" />
    <Binary Include="Gallio\bin\Gallio.Host.Elevated.exe" />
    <PluginFile Include="Gallio\bin\Gallio.Host.Elevated.exe.config" />
    <Binary Include="Gallio\bin\Gallio.Host.Elevated.x86.exe" />
    <PluginFile Include="Gallio\bin\Gallio.Host.Elevated.x86.exe.config" />

    <Binary Include="Gallio.Loader\bin\Gallio.Loader.dll" />
    <Binary Include="Gallio.Loader\bin\Gallio.Loader.pdb" />
    
    <Binary Include="Gallio35\bin\Gallio35.dll" />
    <Binary Include="Gallio35\bin\Gallio35.pdb" />
    <PluginFile Include="Gallio35\Gallio35.plugin" />
    
    <Binary Include="Gallio.UI\bin\Gallio.UI.dll" />
    <Binary Include="Gallio.UI\bin\Gallio.UI.pdb" />
    <PluginFile Include="Gallio.UI\Gallio.UI.plugin" />

    <Binary Include="Gallio.ControlPanel\bin\Gallio.ControlPanel.exe" />
    <PluginFile Include="Gallio.ControlPanel\Gallio.ControlPanel.exe.config" />
    <PluginFile Include="Gallio.ControlPanel\Gallio.ControlPanel.plugin" />
    <Binary Include="Gallio.ControlPanel\Resources\Gallio.ControlPanel.ico">
      <Folder>Resources</Folder>
    </Binary>

    <Binary Include="Gallio.Utility\bin\Gallio.Utility.exe" />
    <PluginFile Include="Gallio.Utility\Gallio.Utility.exe.config" />
    <PluginFile Include="Gallio.Utility\Gallio.Utility.plugin" />
    <Binary Include="Gallio.Utility\Resources\Gallio.Utility.ico">
      <Folder>Resources</Folder>
    </Binary>

    <Binary Include="Gallio.Reports\bin\Gallio.Reports.dll" />
    <Binary Include="Gallio.Reports\bin\Gallio.Reports.pdb" />
    <PluginFile Include="Gallio.Reports\Gallio.Reports.plugin" />
    <Binary Include="Gallio.Reports\Resources\css\*"
            Exclude="Gallio.Reports\Resources\css\Gallio-Report.Generated.css">
        <Folder>Resources\css</Folder>
    </Binary>
    <Binary Include="Gallio.Reports\Resources\js\*">
        <Folder>Resources\js</Folder>
    </Binary>
    <Binary Include="Gallio.Reports\Resources\img\*">
        <Folder>Resources\img</Folder>
    </Binary>
    <Binary Include="Gallio.Reports\Resources\xsl\*">
        <Folder>Resources\xsl</Folder>
    </Binary>
    
    <Content Include="libs\Mono.Cecil.license.html" />
    
    <Document Include="Docs\*.txt" />
    
    <TestAssembly Include="Gallio.Tests\bin\Gallio.Tests.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(DotNet40)'=='true'">
    <CSharpProject Include="Gallio40\Gallio40$(ProjectVariant).csproj" />
    <CSharpProject Include="Gallio40.Tests\Gallio40.Tests$(ProjectVariant).csproj" />
    
    <!-- Reenable when we have some content.
    <DocumentedAssembly Include="Gallio40\bin\Gallio40.dll" />
    -->
    <Binary Include="Gallio40\bin\Gallio40.xml" />
    
    <Binary Include="Gallio40\bin\Gallio40.dll" />
    <Binary Include="Gallio40\bin\Gallio40.pdb" />
    <PluginFile Include="Gallio40\Gallio40.plugin" />
    
    <Feature Include="FEATURE_GALLIO40" />
    
    <TestAssembly Include="Gallio40.Tests\bin\Gallio40.Tests.dll" />
  </ItemGroup>
  
  <ItemGroup>
    <GallioMergeDependency Include="Gallio\bin\Mono.Cecil.dll" />
    <GallioMergeDependency Include="Gallio\bin\NDepend.Helpers.FileDirectoryPath.dll" />
    <GallioMergeDependency Include="Gallio\bin\ICSharpCode.SharpZipLib.dll" />
  </ItemGroup>

  <Target Name="AfterImage"
          DependsOnTargets="GallioImage_ILMerge;GallioImage_NoILMerge;GallioImage_XSD" />

  <Target Name="GallioImage_ILMerge"
          Condition="'$(NoILMerge)'!='true'">
    <Message Text="Running ILMerge on Gallio.dll..."
             Importance="High" />

    <Exec Command="&quot;$(ToolsDir)\ILMerge\ILMerge.exe&quot; &quot;Gallio\bin\Gallio.dll&quot; @(GallioMergeDependency->'&quot;%(Identity)&quot;', ' ') /internalize &quot;/out:$(ImageDir)\bin\Gallio.dll&quot; &quot;/keyfile:$(SourceDir)\Key.snk&quot;" />
  </Target>

  <Target Name="GallioImage_NoILMerge"
          Condition="'$(NoILMerge)'=='true'">
    <Copy SourceFiles="Gallio\bin\Gallio.dll;Gallio\bin\Gallio.pdb;@(GallioMergeDependency)"
          DestinationFolder="$(ImageDir)\bin" />
  </Target>

  <Target Name="GallioImage_XSD">
    <GetFrameworkSdkPath>
      <Output TaskParameter="Path" PropertyName="SdkPath" />
    </GetFrameworkSdkPath>

    <Exec Command="&quot;$(SdkPath)&quot;\bin\xsd.exe &quot;$(ImageDir)\bin\Gallio.dll&quot; /o:&quot;$(TempDir)&quot; /nologo /type:Gallio.Runner.Reports.Report" />
    <Copy SourceFiles="$(TempDir)\schema0.xsd"
          DestinationFiles="$(ImageDir)\bin\Gallio-Report.xsd" />
  </Target>
</Project>
